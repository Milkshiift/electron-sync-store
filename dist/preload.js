import{ipcRenderer as H}from"electron";var G={GET:(q)=>`store:${q}:get`,SET:(q)=>`store:${q}:set`,SET_KEY:(q)=>`store:${q}:set-key`,RESET:(q)=>`store:${q}:reset`,ON_CHANGE:(q)=>`store:${q}:changed`};function F(q){try{return structuredClone(q)}catch(z){return JSON.parse(JSON.stringify(q))}}function L(q){return q!==null&&typeof q==="object"&&!Array.isArray(q)&&!(q instanceof Date)&&!(q instanceof RegExp)}function K(q,z){if(z===void 0)return;if(!L(q)||!L(z))return F(z);let E={...q};for(let B of Object.keys(z)){if(B==="__proto__"||B==="constructor"||B==="prototype")continue;let J=z[B],Q=E[B];if(J===void 0)delete E[B];else E[B]=K(Q,J)}return E}class N{state;listeners=new Set;options;readyPromise;isHydrated=!1;constructor(q){this.options=q,this.state=F(q.defaults),H.on(G.ON_CHANGE(q.name),(z,E)=>{this.isHydrated=!0,this.state=E,this.notify()}),this.readyPromise=H.invoke(G.GET(q.name)).then((z)=>{if(!this.isHydrated)this.state=z,this.isHydrated=!0,this.notify();return this.state}).catch((z)=>{throw console.error("[StoreClient] Init failed",z),z})}async ready(){return this.readyPromise}get(){return F(this.state)}getKey(q){return F(this.state[q])}async set(q){if(!this.options.optimistic){await H.invoke(G.SET(this.options.name),q);return}await this.performOptimisticUpdate(()=>K(this.state,q),()=>H.invoke(G.SET(this.options.name),q))}async setKey(q,z){let E=F(z);if(!this.options.optimistic){await H.invoke(G.SET_KEY(this.options.name),q,E);return}await this.performOptimisticUpdate(()=>{let B=F(this.state);return B[q]=E,B},()=>H.invoke(G.SET_KEY(this.options.name),q,E))}async reset(){await H.invoke(G.RESET(this.options.name))}subscribe(q){return this.listeners.add(q),q(F(this.state)),()=>{this.listeners.delete(q)}}notify(){let q=F(this.state);for(let z of this.listeners)z(q)}async performOptimisticUpdate(q,z){let E=F(this.state),B=q();this.state=B,this.notify();try{await z()}catch(J){if(console.error("[StoreClient] Sync failed, rolling back.",J),JSON.stringify(this.state)===JSON.stringify(B))this.state=E,this.notify();throw J}}}function Z(q){return new N(q)}export{Z as createClient,N as StoreClient};

//# debugId=09006B3F88B5CDC864756E2164756E21
