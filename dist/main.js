import{BrowserWindow as T,ipcMain as G}from"electron";var D={GET:(q)=>`store:${q}:get`,SET:(q)=>`store:${q}:set`,RESET:(q)=>`store:${q}:reset`,ON_CHANGE:(q)=>`store:${q}:changed`};function E(q){try{return structuredClone(q)}catch(z){return JSON.parse(JSON.stringify(q))}}function L(q,z){if(!K(z)||!K(q))return K(z)?E(z):z;if(z instanceof Date)return new Date(z.getTime());if(z instanceof RegExp)return new RegExp(z);if(Array.isArray(z))return E(z);if(Array.isArray(q)||q instanceof Date||q instanceof RegExp)return E(z);let A={...q};for(let F of Object.keys(z)){if(F==="__proto__"||F==="constructor"||F==="prototype")continue;let N=A[F],J=z[F];if(Q(N)&&Q(J))A[F]=L(N,J);else A[F]=K(J)?E(J):J}return A}function K(q){return q!==null&&typeof q==="object"}function Q(q){return K(q)&&!Array.isArray(q)&&!(q instanceof Date)&&!(q instanceof RegExp)}class R{state;options;middleware;initPromise;constructor(q,z=[]){this.options=q,this.state=E(q.defaults),this.middleware=z,this.registerIpc(),this.initPromise=this.init()}async init(){try{for(let q of this.middleware)if(q.onHydrate){let z=await q.onHydrate();if(z)this.state=L(this.state,z)}if(this.options.validate)this.state=this.options.validate(this.state)}catch(q){console.error(`[StoreHost:${this.options.name}] Hydration failed, reverting to defaults.`,q),this.state=E(this.options.defaults)}this.broadcast()}get(){return E(this.state)}async set(q){await this.initPromise;let z=L(this.state,q);if(this.options.validate)this.state=this.options.validate(z);else this.state=z;await Promise.all(this.middleware.map((A)=>A.onPersist?A.onPersist(this.state):Promise.resolve())),this.broadcast()}broadcast(){let q=D.ON_CHANGE(this.options.name);for(let z of T.getAllWindows())if(!z.isDestroyed()&&!z.webContents.isDestroyed())z.webContents.send(q,this.state)}registerIpc(){let{name:q}=this.options;G.removeHandler(D.GET(q)),G.removeHandler(D.SET(q)),G.removeHandler(D.RESET(q)),G.handle(D.GET(q),async()=>{return await this.initPromise,this.get()}),G.handle(D.SET(q),async(z,A)=>{await this.set(A)}),G.handle(D.RESET(q),async()=>{await this.set(this.options.defaults)})}async ready(){await this.initPromise}}function $(q,...z){return new R(q,z)}export{$ as createHost,R as StoreHost};

//# debugId=379B1124A1C4CF3164756E2164756E21
