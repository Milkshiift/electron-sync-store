import{BrowserWindow as U,ipcMain as Q}from"electron";var G={GET:(q)=>`store:${q}:get`,SET:(q)=>`store:${q}:set`,SET_KEY:(q)=>`store:${q}:set-key`,RESET:(q)=>`store:${q}:reset`,ON_CHANGE:(q)=>`store:${q}:changed`};function J(q){try{return structuredClone(q)}catch(x){return JSON.parse(JSON.stringify(q))}}function N(q){return q!==null&&typeof q==="object"&&!Array.isArray(q)&&!(q instanceof Date)&&!(q instanceof RegExp)}function K(q,x){if(x===void 0)return;if(!N(q)||!N(x))return J(x);let z={...q};for(let E of Object.keys(x)){if(E==="__proto__"||E==="constructor"||E==="prototype")continue;let F=x[E],L=z[E];if(F===void 0)delete z[E];else z[E]=K(L,F)}return z}class T{state;options;middleware;initPromise;persistenceQueue=Promise.resolve();constructor(q,x=[]){this.options=q,this.state=J(q.defaults),this.middleware=x,this.initPromise=this.init(),this.registerIpc()}async init(){for(let q of this.middleware)if(q.onHydrate){let x=await q.onHydrate();if(x)this.state=K(this.state,x)}if(this.options.validate)this.state=this.options.validate(this.state)}get(){return J(this.state)}async set(q){await this.initPromise;let x=K(this.state,q);await this.applyState(x)}async setKey(q,x){await this.initPromise;let z=J(this.state);z[q]=x,await this.applyState(z)}async applyState(q){if(this.options.validate)try{q=this.options.validate(q)}catch(x){throw x}if(JSON.stringify(this.state)===JSON.stringify(q))return;this.state=q,this.broadcast(),this.persistenceQueue=this.persistenceQueue.then(()=>Promise.all(this.middleware.map((x)=>x.onPersist?Promise.resolve(x.onPersist(this.state)).catch((z)=>console.error(z)):void 0))).then(()=>{})}broadcast(){let q=G.ON_CHANGE(this.options.name);for(let x of U.getAllWindows())if(!x.isDestroyed()&&!x.webContents.isDestroyed())x.webContents.send(q,this.state)}registerIpc(){let{name:q}=this.options,x=(z,E)=>{Q.removeHandler(z),Q.handle(z,async(F,...L)=>{return await this.initPromise,E(F,...L)})};x(G.GET(q),async()=>{return this.get()}),x(G.SET(q),async(z,E)=>{await this.set(E)}),x(G.SET_KEY(q),async(z,E,F)=>{await this.setKey(E,F)}),x(G.RESET(q),async()=>{await this.applyState(J(this.options.defaults))})}async ready(){await this.initPromise}}function A(q,...x){return new T(q,x)}export{A as createHost,T as StoreHost};

//# debugId=A5D4035C7DD2B27864756E2164756E21
