import{BrowserWindow as n,ipcMain as r}from"electron";var i={GET:(e)=>`store:${e}:get`,SET:(e)=>`store:${e}:set`,ON_CHANGE:(e)=>`store:${e}:changed`};class s{name;middleware;state;initPromise;writeLock=Promise.resolve();constructor(e,t=[]){this.name=e;this.middleware=t;this.initPromise=this.hydrate(),this.registerIpc()}async hydrate(){for(let e of this.middleware)if(e.onHydrate)try{let t=await e.onHydrate();if(t!=null){this.state=t;break}}catch(t){console.error(`[StoreHost] Hydration failed for ${this.name}:`,t)}}get(){if(this.state===void 0)throw Error(`Store "${this.name}" not hydrated`);return this.state}async set(e){await this.initPromise,this.state=structuredClone(e),this.broadcast(),this.persist()}broadcast(){let e=i.ON_CHANGE(this.name);for(let t of n.getAllWindows())if(!t.isDestroyed()&&!t.webContents.isDestroyed())t.webContents.send(e,this.state)}persist(){this.writeLock=this.writeLock.then(async()=>{if(!this.state)return;await Promise.all(this.middleware.map((e)=>e.onPersist?.(this.state)))}).catch((e)=>console.error(`[StoreHost] Persist error in ${this.name}:`,e))}registerIpc(){let e=i.GET(this.name),t=i.SET(this.name);r.removeHandler(e),r.handle(e,async()=>{return await this.initPromise,this.state}),r.removeHandler(t),r.handle(t,async(a,o)=>{await this.set(o)})}ready(){return this.initPromise}}function l(e,...t){return new s(e,t)}export{l as createHost,s as StoreHost};

//# debugId=03D2C66677F74AF964756E2164756E21
