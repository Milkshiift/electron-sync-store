{
  "version": 3,
  "sources": ["../src/main.ts", "../src/types.ts"],
  "sourcesContent": [
    "import { BrowserWindow, ipcMain } from \"electron\";\nimport { Channels, type Middleware } from \"./types\";\n\nexport class StoreHost<T> {\n    private state: T | undefined;\n    private initPromise: Promise<void>;\n    private writeLock: Promise<void> = Promise.resolve();\n\n    constructor(\n        private name: string,\n        private middleware: Middleware<T>[] = []\n    ) {\n        this.initPromise = this.hydrate();\n        this.registerIpc();\n    }\n\n    private async hydrate(): Promise<void> {\n        for (const mw of this.middleware) {\n            if (mw.onHydrate) {\n                try {\n                    const data = await mw.onHydrate();\n                    if (data != null) {\n                        this.state = data;\n                        break;\n                    }\n                } catch (e) {\n                    console.error(`[StoreHost] Hydration failed for ${this.name}:`, e);\n                }\n            }\n        }\n    }\n\n    public get(): Readonly<T> {\n        if (this.state === undefined) throw new Error(`Store \"${this.name}\" not hydrated`);\n        return this.state;\n    }\n\n    public async set(value: T): Promise<void> {\n        await this.initPromise;\n        this.state = structuredClone(value);\n\n        this.broadcast();\n        this.persist();\n    }\n\n    private broadcast(): void {\n        const channel = Channels.ON_CHANGE(this.name);\n        for (const win of BrowserWindow.getAllWindows()) {\n            if (!win.isDestroyed() && !win.webContents.isDestroyed()) {\n                win.webContents.send(channel, this.state);\n            }\n        }\n    }\n\n    private persist(): void {\n        this.writeLock = this.writeLock.then(async () => {\n            if (!this.state) return;\n            await Promise.all(\n                this.middleware.map(mw => mw.onPersist?.(this.state!))\n            );\n        }).catch(err => console.error(`[StoreHost] Persist error in ${this.name}:`, err));\n    }\n\n    private registerIpc(): void {\n        const getChan = Channels.GET(this.name);\n        const setChan = Channels.SET(this.name);\n\n        ipcMain.removeHandler(getChan);\n        ipcMain.handle(getChan, async () => {\n            await this.initPromise;\n            return this.state;\n        });\n\n        ipcMain.removeHandler(setChan);\n        ipcMain.handle(setChan, async (_, value: T) => {\n            await this.set(value);\n        });\n    }\n\n    public ready(): Promise<void> {\n        return this.initPromise;\n    }\n}\n\nexport function createHost<T>(name: string, ...middleware: Middleware<T>[]): StoreHost<T> {\n    return new StoreHost(name, middleware);\n}",
    "export interface Middleware<T> {\n    onHydrate?: () => T | Promise<T | null | undefined>;\n    onPersist?: (state: Readonly<T>) => void | Promise<void>;\n}\n\nexport type Listener<T> = (state: Readonly<T>) => void;\nexport type Unsubscribe = () => void;\n\n/** @internal */\nexport const Channels = {\n    GET: (name: string) => `store:${name}:get`,\n    SET: (name: string) => `store:${name}:set`,\n    ON_CHANGE: (name: string) => `store:${name}:changed`,\n};"
  ],
  "mappings": "AAAA,wBAAS,aAAe,iBCSjB,IAAM,EAAW,CACpB,IAAK,CAAC,IAAiB,SAAS,QAChC,IAAK,CAAC,IAAiB,SAAS,QAChC,UAAW,CAAC,IAAiB,SAAS,WAC1C,EDVO,MAAM,CAAa,CAMV,KACA,WANJ,MACA,YACA,UAA2B,QAAQ,QAAQ,EAEnD,WAAW,CACC,EACA,EAA8B,CAAC,EACzC,CAFU,YACA,kBAER,KAAK,YAAc,KAAK,QAAQ,EAChC,KAAK,YAAY,OAGP,QAAO,EAAkB,CACnC,QAAW,KAAM,KAAK,WAClB,GAAI,EAAG,UACH,GAAI,CACA,IAAM,EAAO,MAAM,EAAG,UAAU,EAChC,GAAI,GAAQ,KAAM,CACd,KAAK,MAAQ,EACb,OAEN,MAAO,EAAG,CACR,QAAQ,MAAM,oCAAoC,KAAK,QAAS,CAAC,GAM1E,GAAG,EAAgB,CACtB,GAAI,KAAK,QAAU,OAAW,MAAU,MAAM,UAAU,KAAK,oBAAoB,EACjF,OAAO,KAAK,WAGH,IAAG,CAAC,EAAyB,CACtC,MAAM,KAAK,YACX,KAAK,MAAQ,gBAAgB,CAAK,EAElC,KAAK,UAAU,EACf,KAAK,QAAQ,EAGT,SAAS,EAAS,CACtB,IAAM,EAAU,EAAS,UAAU,KAAK,IAAI,EAC5C,QAAW,KAAO,EAAc,cAAc,EAC1C,GAAI,CAAC,EAAI,YAAY,GAAK,CAAC,EAAI,YAAY,YAAY,EACnD,EAAI,YAAY,KAAK,EAAS,KAAK,KAAK,EAK5C,OAAO,EAAS,CACpB,KAAK,UAAY,KAAK,UAAU,KAAK,SAAY,CAC7C,GAAI,CAAC,KAAK,MAAO,OACjB,MAAM,QAAQ,IACV,KAAK,WAAW,IAAI,KAAM,EAAG,YAAY,KAAK,KAAM,CAAC,CACzD,EACH,EAAE,MAAM,KAAO,QAAQ,MAAM,gCAAgC,KAAK,QAAS,CAAG,CAAC,EAG5E,WAAW,EAAS,CACxB,IAAM,EAAU,EAAS,IAAI,KAAK,IAAI,EAChC,EAAU,EAAS,IAAI,KAAK,IAAI,EAEtC,EAAQ,cAAc,CAAO,EAC7B,EAAQ,OAAO,EAAS,SAAY,CAEhC,OADA,MAAM,KAAK,YACJ,KAAK,MACf,EAED,EAAQ,cAAc,CAAO,EAC7B,EAAQ,OAAO,EAAS,MAAO,EAAG,IAAa,CAC3C,MAAM,KAAK,IAAI,CAAK,EACvB,EAGE,KAAK,EAAkB,CAC1B,OAAO,KAAK,YAEpB,CAEO,SAAS,CAAa,CAAC,KAAiB,EAA2C,CACtF,OAAO,IAAI,EAAU,EAAM,CAAU",
  "debugId": "03D2C66677F74AF964756E2164756E21",
  "names": []
}